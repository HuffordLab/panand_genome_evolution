
## Inferring a multiple alignment from PanAnd genome assemblies

A multiple alignment for the PanAnd genomes was inferred using Cactus v2.1.1 using a stepwise approach. Individual progressive steps in the Cactus procedure were output usng `cactus-prepare`.

```
cactus_env/bin/cactus-prepare panand_config.txt --outDir panand-steps-output --outSeqFile panand-steps-output/panand.txt --outHal panand-steps-output/panand.hal --jobStore jobstore_panand
```

The input tree topology and branch lengths were inferred using mashtree v1.2.0 and checked for consistency with the known phylogeny of the clade. Cactus is documented to by relatively robust to some misspecification in the tree and branch lengths so mashtree result was deemed acceptable.

```
mashtree_bootstrap.pl --reps 100 --numcpus 24 --mindepth 0 --sketch-size 100000 --genomesize 1000000000 *.fa > mashtree.100k_sketch.bootstrap.dnd
```

The resulting HAL alignment graph was converted to MAF format using the `hal2maf` utility.

```
hal2maf --noAncestors --refGenome zB73v5 --refSequence chr1 panand.hal chr1.maf
```

An supplementary MAF file reduced to a single sequence per species per alignment block was later generated using the Cactus v2.8.4 `cactus-hal2maf` utility:

```
cactus-hal2maf --noAncestors --chunkSize 1000000 --refSequence chr1 --batchCount 2 --batchCores 2 --dupeMode single --refGenome zB73v5 --filterGapCausingDupes jobstore_hal2maf_single_chr1 panand.hal chr1_single.maf.gz
```

As the Cactus orthology filter was not found to adequately detect orthology in these complex grass genomes, several custom python scripts were used together with the pre-generated information on gene collinearity and subgenomes to filter the alignment down to a single sequence per subgenome per alignment block.

```
filter_maf_by_synteny_and_subgenome.py panand_collinearity.txt panand_subgenomes.txt panand_chr1.maf > panand_chr1.subfilt.maf
clean_syntenic_subgenomic_maf.py panand_collinearity.txt panand_chr1.subfilt.maf > panand_chr1.single.maf
```

These scripts will remove alignments outside of syntenic regions and ensure that Tripsacineae subgenomes are correctly matched in the alignments (maize1 aligned to maize1 and maize2 aligned to maize2). In the relatively rare cases that there are multiple matching alignments, only the first will be retained. Later efforts prototyped ways to minimize sudden breaks or location switches in the alignment using a shortest path algoritm (`find_shortest_species_path.py`) and combined the filtering steps into one (`filter_and_clean_maf_by_synteny_and_subgenome.py`).

Unnecessary annotations like the maize subgenomes can then be removed.
```
sed 's/@maize1//' $l| sed 's/@maize2//'| sed 's/@/_/' panand_chr1.single.maf > panand_chr1.single.tidy.maf
```

Alignment coverage statistics can be generated by parsing the MAF file.
```
maf2subgenomecov.py panand_chr1.single.tidy.maf > panand_chr1.single.tidy.coverage.txt
```

To reduce reference bias in the detection of accelerated Tripsacineae-specific conserved elements, the Tripsacineae species were removed and the reference genome masked.

```
subset_species_maf.py panand_chr1.single.tidy.maf achine,agerar,avirgi,blagur,ccitra,crefra,etrips,hconto,hcompr,irugos,ppanic,rrottb,rtuber,smicro,sscopa,telega,ttrian,udigit,vcuspi,sbicol,sspont,aburma,snutan,zB73v5 > panand_chr1.single.tidy.notrips.maf
maf_mask_ref.py panand_chr1.single.tidy.notrips.maf > panand_chr1.single.tidy.notrips.refmask.maf
```

To ensure the resulting MAF files can be processed using various tools, it is important to add the MAF header, e.g. `##maf version=1` and to remove empty blocks after species filtering using a utility like MafTools.
```
mafFilter --noDegreeLT 2 --maf panand_chr1.single.tidy.notrips.refmask.maf > panand_chr1.single.tidy.notrips.refmask.nodegreelt2.maf
```
